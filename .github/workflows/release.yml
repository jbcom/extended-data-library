name: Release

on:
  push:
    branches: [main]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  # ==========================================================================
  # Detect which packages changed
  # ==========================================================================
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      edt: ${{ steps.filter.outputs.edt }}
      logging: ${{ steps.filter.outputs.logging }}
      inputs: ${{ steps.filter.outputs.inputs }}
      connectors: ${{ steps.filter.outputs.connectors }}
      go: ${{ steps.filter.outputs.go }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            edt:
              - 'packages/extended-data-types/src/**'
              - 'packages/extended-data-types/pyproject.toml'
            logging:
              - 'packages/lifecyclelogging/src/**'
              - 'packages/lifecyclelogging/pyproject.toml'
            inputs:
              - 'packages/directed-inputs-class/src/**'
              - 'packages/directed-inputs-class/pyproject.toml'
            connectors:
              - 'packages/vendor-connectors/src/**'
              - 'packages/vendor-connectors/pyproject.toml'
            go:
              - 'packages/secretssync/**'

  # ==========================================================================
  # Release: extended-data-types
  # ==========================================================================
  release-edt:
    name: Release extended-data-types
    needs: changes
    if: needs.changes.outputs.edt == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tools
        run: uv tool install python-semantic-release

      - name: Check if release needed
        id: check
        working-directory: packages/extended-data-types
        run: |
          NEW_VERSION=$(semantic-release --noop version --print 2>/dev/null || true)
          if [ -n "$NEW_VERSION" ]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run semantic-release
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/extended-data-types
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release version

      - name: Build package
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/extended-data-types
        run: uv build

      - name: Publish to PyPI
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/extended-data-types
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish --token "$UV_PUBLISH_TOKEN"

  # ==========================================================================
  # Release: lifecyclelogging
  # ==========================================================================
  release-logging:
    name: Release lifecyclelogging
    needs: [changes, release-edt]
    if: always() && needs.changes.outputs.logging == 'true' && needs.release-edt.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tools
        run: uv tool install python-semantic-release

      - name: Check if release needed
        id: check
        working-directory: packages/lifecyclelogging
        run: |
          NEW_VERSION=$(semantic-release --noop version --print 2>/dev/null || true)
          if [ -n "$NEW_VERSION" ]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run semantic-release
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/lifecyclelogging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release version

      - name: Build package
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/lifecyclelogging
        run: uv build

      - name: Publish to PyPI
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/lifecyclelogging
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish --token "$UV_PUBLISH_TOKEN"

  # ==========================================================================
  # Release: directed-inputs-class
  # ==========================================================================
  release-inputs:
    name: Release directed-inputs-class
    needs: [changes, release-edt]
    if: always() && needs.changes.outputs.inputs == 'true' && needs.release-edt.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tools
        run: uv tool install python-semantic-release

      - name: Check if release needed
        id: check
        working-directory: packages/directed-inputs-class
        run: |
          NEW_VERSION=$(semantic-release --noop version --print 2>/dev/null || true)
          if [ -n "$NEW_VERSION" ]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run semantic-release
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/directed-inputs-class
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release version

      - name: Build package
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/directed-inputs-class
        run: uv build

      - name: Publish to PyPI
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/directed-inputs-class
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish --token "$UV_PUBLISH_TOKEN"

  # ==========================================================================
  # Release: vendor-connectors
  # ==========================================================================
  release-connectors:
    name: Release vendor-connectors
    needs: [changes, release-edt, release-logging, release-inputs]
    if: always() && needs.changes.outputs.connectors == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tools
        run: uv tool install python-semantic-release

      - name: Check if release needed
        id: check
        working-directory: packages/vendor-connectors
        run: |
          NEW_VERSION=$(semantic-release --noop version --print 2>/dev/null || true)
          if [ -n "$NEW_VERSION" ]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run semantic-release
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/vendor-connectors
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release version

      - name: Build package
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/vendor-connectors
        run: uv build

      - name: Publish to PyPI
        if: steps.check.outputs.should_release == 'true'
        working-directory: packages/vendor-connectors
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish --token "$UV_PUBLISH_TOKEN"

  # ==========================================================================
  # Release: secretssync (Go via GoReleaser)
  # ==========================================================================
  release-go:
    name: Release secretssync
    needs: changes
    if: needs.changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache-dependency-path: packages/secretssync/go.sum

      - name: Check for version tag
        id: check
        run: |
          LATEST_TAG=$(git tag --list 'secretssync-v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST_TAG" ]; then
            echo "No secretssync tags found, skipping release."
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            COMMITS_SINCE=$(git rev-list "${LATEST_TAG}..HEAD" --count -- packages/secretssync/)
            if [ "$COMMITS_SINCE" -gt 0 ]; then
              echo "should_release=true" >> "$GITHUB_OUTPUT"
            else
              echo "should_release=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Run GoReleaser
        if: steps.check.outputs.should_release == 'true'
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
          workdir: packages/secretssync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
