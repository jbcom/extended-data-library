name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==========================================================================
  # Detect which packages changed
  # ==========================================================================
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      edt: ${{ steps.filter.outputs.edt }}
      logging: ${{ steps.filter.outputs.logging }}
      inputs: ${{ steps.filter.outputs.inputs }}
      connectors: ${{ steps.filter.outputs.connectors }}
      go: ${{ steps.filter.outputs.go }}
      python_any: ${{ steps.filter.outputs.python_any }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            edt:
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            logging:
              - 'packages/lifecyclelogging/**'
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            inputs:
              - 'packages/directed-inputs-class/**'
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            connectors:
              - 'packages/vendor-connectors/**'
              - 'packages/extended-data-types/**'
              - 'packages/lifecyclelogging/**'
              - 'packages/directed-inputs-class/**'
              - 'pyproject.toml'
              - 'tox.ini'
            go:
              - 'packages/secretssync/**'
            python_any:
              - 'packages/extended-data-types/**'
              - 'packages/lifecyclelogging/**'
              - 'packages/directed-inputs-class/**'
              - 'packages/vendor-connectors/**'
              - 'pyproject.toml'
              - 'tox.ini'

  # ==========================================================================
  # Lint all Python packages
  # ==========================================================================
  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.python_any == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run linting
        run: tox -e lint

  # ==========================================================================
  # Type-check all Python packages
  # ==========================================================================
  typecheck:
    name: Type check
    needs: changes
    if: needs.changes.outputs.python_any == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run type checking
        run: tox -e typecheck

  # ==========================================================================
  # Test: extended-data-types
  # ==========================================================================
  test-edt:
    name: Test edt / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.edt == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests
        run: tox -e edt

  # ==========================================================================
  # Test: lifecyclelogging
  # ==========================================================================
  test-logging:
    name: Test logging / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.logging == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests
        run: tox -e logging

  # ==========================================================================
  # Test: directed-inputs-class
  # ==========================================================================
  test-inputs:
    name: Test inputs / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.inputs == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests
        run: tox -e inputs

  # ==========================================================================
  # Test: vendor-connectors
  # ==========================================================================
  test-connectors:
    name: Test connectors / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.connectors == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests
        run: tox -e connectors

  # ==========================================================================
  # Test: secretssync (Go)
  # ==========================================================================
  test-go:
    name: Test secretssync (Go)
    needs: changes
    if: needs.changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: packages/secretssync/go.sum

      - name: Run Go tests
        working-directory: packages/secretssync
        run: go test -v -race ./...

      - name: Run Go vet
        working-directory: packages/secretssync
        run: go vet ./...

  # ==========================================================================
  # CI gate - single status check for branch protection
  # ==========================================================================
  ci-pass:
    name: CI
    if: always()
    needs: [lint, typecheck, test-edt, test-logging, test-inputs, test-connectors, test-go]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        env:
          LINT: ${{ needs.lint.result }}
          TYPECHECK: ${{ needs.typecheck.result }}
          EDT: ${{ needs.test-edt.result }}
          LOGGING: ${{ needs.test-logging.result }}
          INPUTS: ${{ needs.test-inputs.result }}
          CONNECTORS: ${{ needs.test-connectors.result }}
          GO: ${{ needs.test-go.result }}
        run: |
          results=("$LINT" "$TYPECHECK" "$EDT" "$LOGGING" "$INPUTS" "$CONNECTORS" "$GO")
          for result in "${results[@]}"; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              echo "One or more jobs failed or were cancelled."
              exit 1
            fi
          done
          echo "All required checks passed."
