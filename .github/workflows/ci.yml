name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==========================================================================
  # PR labeler (only on pull_request)
  # ==========================================================================
  label:
    name: Label PR
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/labeler@v5
        with:
          configuration-path: .github/labeler.yml

  # ==========================================================================
  # Detect which packages changed
  # ==========================================================================
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      edt: ${{ steps.filter.outputs.edt }}
      logging: ${{ steps.filter.outputs.logging }}
      inputs: ${{ steps.filter.outputs.inputs }}
      connectors: ${{ steps.filter.outputs.connectors }}
      go: ${{ steps.filter.outputs.go }}
      docs: ${{ steps.filter.outputs.docs }}
      python_any: ${{ steps.filter.outputs.python_any }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            edt:
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            logging:
              - 'packages/lifecyclelogging/**'
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            inputs:
              - 'packages/directed-inputs-class/**'
              - 'packages/extended-data-types/**'
              - 'pyproject.toml'
              - 'tox.ini'
            connectors:
              - 'packages/vendor-connectors/**'
              - 'packages/extended-data-types/**'
              - 'packages/lifecyclelogging/**'
              - 'packages/directed-inputs-class/**'
              - 'pyproject.toml'
              - 'tox.ini'
            go:
              - 'packages/secretssync/**'
            docs:
              - 'docs/**'
              - 'packages/*/src/**'
            python_any:
              - 'packages/extended-data-types/**'
              - 'packages/lifecyclelogging/**'
              - 'packages/directed-inputs-class/**'
              - 'packages/vendor-connectors/**'
              - 'pyproject.toml'
              - 'tox.ini'

  # ==========================================================================
  # Lint all Python packages
  # ==========================================================================
  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.python_any == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run linting
        run: tox -e lint

  # ==========================================================================
  # Type-check all Python packages
  # ==========================================================================
  typecheck:
    name: Type check
    needs: changes
    if: needs.changes.outputs.python_any == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run type checking
        run: tox -e typecheck

  # ==========================================================================
  # Test: extended-data-types
  # ==========================================================================
  test-edt:
    name: Test edt / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.edt == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests with coverage
        run: tox -e edt

      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-edt
          path: packages/extended-data-types/coverage.xml

  # ==========================================================================
  # Test: lifecyclelogging
  # ==========================================================================
  test-logging:
    name: Test logging / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.logging == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests with coverage
        run: tox -e logging

      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-logging
          path: packages/lifecyclelogging/coverage.xml

  # ==========================================================================
  # Test: directed-inputs-class
  # ==========================================================================
  test-inputs:
    name: Test inputs / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.inputs == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests with coverage
        run: tox -e inputs

      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-inputs
          path: packages/directed-inputs-class/coverage.xml

  # ==========================================================================
  # Test: vendor-connectors
  # ==========================================================================
  test-connectors:
    name: Test connectors / py${{ matrix.python-version }}
    needs: changes
    if: needs.changes.outputs.connectors == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Run tests with coverage
        run: tox -e connectors

      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-connectors
          path: packages/vendor-connectors/coverage.xml

  # ==========================================================================
  # Test: secretssync (Go)
  # ==========================================================================
  test-go:
    name: Test secretssync (Go)
    needs: changes
    if: needs.changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: packages/secretssync/go.sum

      - name: Run Go tests
        working-directory: packages/secretssync
        run: go test -v -race ./...

      - name: Run Go vet
        working-directory: packages/secretssync
        run: go vet ./...

  # ==========================================================================
  # Test: docs (unit tests + Astro build)
  # ==========================================================================
  test-docs:
    name: Test docs
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Build Sphinx API docs
        run: tox -e docs

      - name: Add Starlight frontmatter to API docs
        run: |
          python3 -c "
          import glob
          for f in sorted(glob.glob('docs/src/content/docs/api/*.md')):
              with open(f) as fh:
                  content = fh.read()
              if not content.startswith('---'):
                  title = content.split('\n')[0].lstrip('# ')
                  with open(f, 'w') as fh:
                      fh.write(f'---\ntitle: \"{title}\"\n---\n\n{content}')
          "

      - name: Install docs dependencies
        working-directory: docs
        run: npm ci || npm install

      - name: Run unit tests
        working-directory: docs
        run: npm test

      - name: Build Astro site
        working-directory: docs
        run: npm run build

  # ==========================================================================
  # Test: docs E2E (Playwright)
  # ==========================================================================
  test-docs-e2e:
    name: Test docs E2E
    needs: [changes, test-docs]
    if: needs.changes.outputs.docs == 'true' && needs.test-docs.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/pyproject.toml"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install tox
        run: uv tool install tox --with tox-uv --with tox-gh

      - name: Build Sphinx API docs
        run: tox -e docs

      - name: Add Starlight frontmatter to API docs
        run: |
          python3 -c "
          import glob
          for f in sorted(glob.glob('docs/src/content/docs/api/*.md')):
              with open(f) as fh:
                  content = fh.read()
              if not content.startswith('---'):
                  title = content.split('\n')[0].lstrip('# ')
                  with open(f, 'w') as fh:
                      fh.write(f'---\ntitle: \"{title}\"\n---\n\n{content}')
          "

      - name: Install docs dependencies
        working-directory: docs
        run: npm ci || npm install

      - name: Install Playwright browsers
        working-directory: docs
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: docs
        run: npx playwright test

  # ==========================================================================
  # SonarCloud: extended-data-types
  # ==========================================================================
  sonar-edt:
    name: SonarCloud edt
    needs: [changes, test-edt]
    if: always() && needs.changes.outputs.edt == 'true' && needs.test-edt.result == 'success'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: coverage-edt
          path: packages/extended-data-types

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          projectBaseDir: packages/extended-data-types
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================================================
  # SonarCloud: lifecyclelogging
  # ==========================================================================
  sonar-logging:
    name: SonarCloud logging
    needs: [changes, test-logging]
    if: always() && needs.changes.outputs.logging == 'true' && needs.test-logging.result == 'success'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: coverage-logging
          path: packages/lifecyclelogging

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          projectBaseDir: packages/lifecyclelogging
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================================================
  # SonarCloud: directed-inputs-class
  # ==========================================================================
  sonar-inputs:
    name: SonarCloud inputs
    needs: [changes, test-inputs]
    if: always() && needs.changes.outputs.inputs == 'true' && needs.test-inputs.result == 'success'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: coverage-inputs
          path: packages/directed-inputs-class

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          projectBaseDir: packages/directed-inputs-class
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================================================
  # SonarCloud: vendor-connectors
  # ==========================================================================
  sonar-connectors:
    name: SonarCloud connectors
    needs: [changes, test-connectors]
    if: always() && needs.changes.outputs.connectors == 'true' && needs.test-connectors.result == 'success'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: coverage-connectors
          path: packages/vendor-connectors

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          projectBaseDir: packages/vendor-connectors
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================================================
  # CI gate - single status check for branch protection
  # ==========================================================================
  ci-pass:
    name: CI
    if: always()
    needs:
      - lint
      - typecheck
      - test-edt
      - test-logging
      - test-inputs
      - test-connectors
      - test-go
      - test-docs
      - test-docs-e2e
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        env:
          LINT: ${{ needs.lint.result }}
          TYPECHECK: ${{ needs.typecheck.result }}
          EDT: ${{ needs.test-edt.result }}
          LOGGING: ${{ needs.test-logging.result }}
          INPUTS: ${{ needs.test-inputs.result }}
          CONNECTORS: ${{ needs.test-connectors.result }}
          GO: ${{ needs.test-go.result }}
          DOCS: ${{ needs.test-docs.result }}
          DOCS_E2E: ${{ needs.test-docs-e2e.result }}
        run: |
          results=(
            "$LINT" "$TYPECHECK"
            "$EDT" "$LOGGING" "$INPUTS" "$CONNECTORS" "$GO"
            "$DOCS" "$DOCS_E2E"
          )
          for result in "${results[@]}"; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              echo "One or more jobs failed or were cancelled."
              exit 1
            fi
          done
          echo "All required checks passed."
